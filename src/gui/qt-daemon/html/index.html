<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns="http://www.w3.org/1999/html">
<head>
    <meta http-equiv="Content-Type" content="text/html;" />

    <!--  <link rel="stylesheet" href="files/jquery-ui-1.10.2.custom.css" /> -->
    <link rel="stylesheet" href="files/css/start/jquery-ui-1.10.4.custom.css"/>
    <link rel="stylesheet" type="text/css" href="files/style.css" />

    <!--  <script src="files/http_code.jquery.com_jquery-latest.js"></script> -->
    <!--  <script src="files/http_code.jquery.com_ui_1.10.2_jquery-ui.js"></script> -->
    <script src="files/js/jquery-1.10.2.js"></script>
    <script src="files/js/jquery-ui-1.10.4.custom.js"></script>
    <script src="files/ui_helper.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>

<div id="container">
    <div id="main_menu_bar" class="inline_menu_bar">
        <div id="daemon_state_view_menu" class="inline_menu_bar_item"  view_name="daemon_state_view">Connectivity</div>
        <div id="wallet_view_menu"  class="inline_menu_bar_item" view_name="wallet_view">Wallet</div>
    </div>

    <div id="daemon_state_view" class="view_hidden menu_view_inner_area" >
        <div class="daemon_view_general_status_block"><span class="daemon_view_general_status_text">Status:</span> <span  id="daemon_status_text">Loading blockchain data...</span></div>
        <div id="synchronization_progressbar_block">
            <div style="width: 200px; height: 20px;float: left;" id="synchronization_progressbar"></div><span style="margin-left: 10px;" id="daemon_synchronization_text">--</span>
        </div>
        <div class="daemon_view_details_block">
            <div class="daemon_view_details_status_block">
                <span class="daemon_view_param_title">Connections: </span>
                <span class="daemon_view_param_value" id="daemon_out_connections_text">0</span>  <!-- (out)/<span id="daemon_inc_connections_text">0</span>(inc)</span> -->
            </div>
            <div class="daemon_view_details_status_block">
                <span class="daemon_view_param_title">Height: </span>
                <span class="daemon_view_param_value" id="daemon_height_text">0</span>  <!-- (out)/<span id="daemon_inc_connections_text">0</span>(inc)</span> -->
            </div>
            <div class="daemon_view_details_status_block">
                <span class="daemon_view_param_title">Current difficulty: </span>
                <span class="daemon_view_param_value" id="difficulty_text">---</span>
            </div>
            <div class="daemon_view_details_status_block">
                <span class="daemon_view_param_title">Current network hashrate: </span>
                <span class="daemon_view_param_value" id="hashrate_text">---</span>
            </div>
        </div>
        <div id="open_wallet_button" class="common_button">Open wallet</div>
    </div>
    <div id="wallet_view" class="view_hidden menu_view_inner_area" >
        <div id="wallet_left_panel">
            <div class="wallet_left_panel_entry">
                <span class="balance_text">Balance:</span>
                <span class="wallet_balance" id="wallet_balance">0.0</span>
                <span class="balance_text">Unlocked:</span>
                <span class="wallet_balance" id="wallet_unlocked_balance">0.0</span>
            </div>
            <div id="synchronizing_wallet_block">
                Synchronizing wallet...
                <div style="width: 150px; height: 20px;" id="wallet_progressbar"></div>
            </div>
            <div id="synchronized_wallet_block" style="display: none">
                Synchronized
            </div>
            <!-- <div id="close_wallet_button_id" class="common_button">Close wallet</div> -->
        </div>
        <div id="wallet_transfer_panel">
            <div>
                <table cellspacing="3px">
                    <tr>
                        <td width="90px">Address:</td>
                        <td><input id="transfer_address_id"><br></td>
                    </tr>
                    <tr>
                        <td>Amount:</td>
                        <td><input pattern="[0-9]+(\.[0-9]{1,12})?" id="transfer_amount_id" value="0.0">  <a href="javascript:;" onclick="jQuery('.transfer_extra_options').toggle('fast');" class="options_link_text">More options...</a> </td>
                    </tr>
                    <tr>
                        <td > <span class="transfer_extra_options">Payment id: </span> </td>
                        <td > <span class="transfer_extra_options"><input style="width: 400px" id="payment_id"></span></td>
                    </tr>
                    <tr>
                        <td > <span class="transfer_extra_options">Mixin: </span> </td>
                        <td > <span class="transfer_extra_options"><input type="number" style="width: 40px" id="mixin_count_id" value="0"></span></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td><div id="transfer_button_id" class="common_button">Send</div></td>
                    </tr>
                </table>
            </div>
        </div>
        <div id="wallet_recent_transfers_panel">
            <h3 class="balance_text">Recent transfers:</h3>
            <div id="recent_transfers_container_id"></div>
        </div>
    </div>
</div>

<script type="text/javascript">

function on_update_daemon_state(info_obj)
{
    //var info_obj = jQuery.parseJSON(daemon_info_str);

    if(info_obj.daemon_network_state == 0)//daemon_network_state_connecting
    {
        //do nothing
    }else if(info_obj.daemon_network_state == 1)//daemon_network_state_synchronizing
    {
        var percents = 0;
        if (info_obj.max_net_seen_height > info_obj.synchronization_start_height)
         percents = ((info_obj.height - info_obj.synchronization_start_height)*100)/(info_obj.max_net_seen_height - info_obj.synchronization_start_height);
        $("#synchronization_progressbar").progressbar( "option", "value", percents );
        $("#daemon_synchronization_text").text((info_obj.max_net_seen_height - info_obj.height).toString() + " blocks behind");
        //show progress
    }else if(info_obj.daemon_network_state == 2)//daemon_network_state_online
    {
        $("#synchronization_progressbar_block").hide();
        $("#daemon_status_text").addClass("daemon_view_general_status_value_success_text");
        $("#open_wallet_button").button("enable");
        //show OK
    }else if(info_obj.daemon_network_state == 3)//deinit
    {
        $("#synchronization_progressbar_block").show();
        $("#synchronization_progressbar" ).progressbar({value: false });
        $("#daemon_synchronization_text").text("");

        $("#daemon_status_text").removeClass("daemon_view_general_status_value_success_text");
        $("#open_wallet_button").button("disable");

        inline_menu_item_select(document.getElementById('daemon_state_view_menu'));
        disable_tab(document.getElementById('wallet_view_menu'), true);
        //show OK
    }
    else
    {
        //set unknown status
        $("#daemon_status_text").text("Unkonwn state");
        return;
    }

    $("#daemon_status_text").text(info_obj.text_state);

    $("#daemon_out_connections_text").text(info_obj.out_connections_count.toString());
    if(info_obj.out_connections_count >= 8)
    {
        $("#daemon_out_connections_text").addClass("daemon_view_general_status_value_success_text");
    }
    //$("#daemon_inc_connections_text").text(info_obj.inc_connections_count.toString());

    $("#daemon_height_text").text(info_obj.height.toString());
    $("#difficulty_text").text(info_obj.difficulty);
    $("#hashrate_text").text(info_obj.hashrate.toString());
}



function on_update_wallet_status(wal_status)
{

    if(wal_status.wallet_state == 1)
    {
        //syncmode
        $("#transfer_button_id").button("disable");
        $("#synchronizing_wallet_block").show();
        $("#synchronized_wallet_block").hide();
    }else if(wal_status.wallet_state == 2)
    {
        $("#transfer_button_id").button("enable");
        $("#synchronizing_wallet_block").hide();
        $("#synchronized_wallet_block").show();
    }
    else
    {
        alert("wrong state");
    }
}

function get_transfer_html_entry(tr)
{
    var res;
    if(tr.is_income)
        res = "<span style='color: darkgreen'> Height: " + tr.height.toString() + " tx: " + tr.tx_hash + " received " + tr.amount + "</span><br>";
    else
        res = "<span style='color: darkmagenta'> Height: " + tr.height.toString() + " tx: " + tr.tx_hash + " spent " + tr.amount + "</span><br>";

    return res;
}

function on_update_wallet_info(wal_status)
{
    $("#wallet_balance").text(wal_status.balance);
    $("#wallet_unlocked_balance").text(wal_status.unlocked_balance);
}

function on_money_recieved(tei)
{
    $("#recent_transfers_container_id").prepend( get_transfer_html_entry(tei.ti) );
    $("#wallet_balance").text(tei.balance);
    $("#wallet_unlocked_balance").text(tei.unlocked_balance);
}

function on_money_spent(tei)
{
    $("#recent_transfers_container_id").prepend( get_transfer_html_entry(tei.ti) );
    $("#wallet_balance").text(tei.balance);
    $("#wallet_unlocked_balance").text(tei.unlocked_balance);
}

function on_open_wallet()
{
    Qt_parent.open_wallet();
}

function on_show_wallet()
{
    disable_tab(document.getElementById('wallet_view_menu'), false);
    inline_menu_item_select(document.getElementById('wallet_view_menu'));
}

function on_transfer()
{
    var transfer_obj = {
        destinations:[
            {
                address: $('#transfer_address_id').val(),
                amount: $('#transfer_amount_id').val()
            }
        ],
        mixin_count: 0,
        payment_id: $('#payment_id').val()
    };

    transfer_obj.mixin_count = parseInt($('#mixin_count_id').val());
    if(!(transfer_obj.mixin_count >= 0 && transfer_obj.mixin_count < 11))
    {
        Qt_parent.message_box("Wrong Mixin parameter value, please set values in range 0-10");
        return;
    }

    var transfer_res_str = Qt_parent.transfer(JSON.stringify(transfer_obj));
    var transfer_res_obj = jQuery.parseJSON(transfer_res_str);

    if(transfer_res_obj.success)
    {
        $('#transfer_address_id').val("");
        $('#transfer_amount_id').val("");
        $('#payment_id').val("");
        $('#mixin_count_id').val(0);

        $("#recent_transfers_container_id").prepend("<span style='color: darkblue'> Money successfully sent, transaction " + transfer_res_obj.tx_hash + ", " + transfer_res_obj.tx_blob_size + " bytes</span><br>");
    }
    else
        return;
}

function str_to_obj(str)
{
    var info_obj = jQuery.parseJSON(str);
    this.cb(info_obj);
}

$(function()
{ // DOM ready
    $( "#synchronization_progressbar" ).progressbar({value: false });
    $( "#wallet_progressbar" ).progressbar({value: false });
    $(".common_button").button();
    $("#open_wallet_button").button("disable");
    //$("#transfer_button_id").button("disable");
    $('#open_wallet_button').on('click',  on_open_wallet);
    $('#transfer_button_id').on('click',  on_transfer);


    /*on_money_recieved({
        height: 10,
        tx_hash: "980809809809808",
        amount: "10.1111"
    });*/

    inline_menu_item_select(document.getElementById('daemon_state_view_menu'));
    //inline_menu_item_select(document.getElementById('wallet_view_menu'));

    Qt.update_daemon_state.connect(str_to_obj.bind({cb: on_update_daemon_state}));
    Qt.update_wallet_status.connect(str_to_obj.bind({cb: on_update_wallet_status}));
    Qt.update_wallet_info.connect(str_to_obj.bind({cb: on_update_wallet_info}));
    Qt.money_receive.connect(str_to_obj.bind({cb: on_money_recieved}));
    Qt.money_spent.connect(str_to_obj.bind({cb: on_money_spent}));
    Qt.show_wallet.connect(on_show_wallet);

    // put it here to disable wallet tab only in qt-mode
    disable_tab(document.getElementById('wallet_view_menu'), true);

});

</script>
</body>
</html>
